{% extends "base.html" %}

{% block title %} Lista de Expedientes {% endblock %}

{% block body %}
{% include "../components/navbar.html" %}
<style>
    label.form-label {
        font-weight: 500;
    }

    .modal-content {
        border-radius: 1rem;
    }

    .form-control:focus {
        border-color: #F2FDFF !important;
        box-shadow: 0 0 0 0.2rem rgb(237, 237, 237);
    }
    .form-select:focus {
        border-color: #F2FDFF !important;
        box-shadow: 0 0 0 0.2rem rgb(237, 237, 237);
    }

    .table-bordered-gray {
        border: 1px solid #000;
        border-collapse: collapse;
    }

    .table-bordered-gray th,
    .table-bordered-gray td {
        border: 1px solid #000;
    }
 
    .action-column .btn {
    min-width: 34px;
    min-height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, opacity 0.2s ease;

}



.action-column .btn:hover {
    transform: translateY(-2px);
    opacity: 0.9;

}

</style>

<div style="text-align: center;">
    <div style="font-weight: bold; font-size: 24px; color: #000;">
        LISTADO DE EXPEDIENTES
    </div>
</div>

<div class="px-3" style="background-color: #F2FDFF;">
 <!-- Secci√≥n de b√∫squeda -->
                    <h5 class="mb-2">Filtros para localizar el expediente&nbsp;&nbsp;<i class="bi bi-search"></i></h5>
                    <div class="row mb-3">
                        <!-- Item -->
                        <div class="col">
                            <label class="form-label">Item</label>
                            <input type="text" class="form-control filter-input" data-column="0">
                        </div>
                        <!-- Expediente -->
                        <div class="col">
                            <label class="form-label">Expediente</label>
                            <input type="text" class="form-control filter-input" data-column="1">
                        </div>
                        <div class="col">
                            <label class="form-label">Materia</label>
                            <input type="text" class="form-control filter-input" data-column="4">
                        </div>
                        <div class="col ">
                            <label class="form-label">Juzgado</label>
                            <input type="text" class="form-control filter-input" data-column="5">
                        </div>
                        <!--Centro de Costo -->
                        <div class="col">
                            <label class="form-label">Demandante</label>
                            <input type="text" class="form-control filter-input" data-column="6">
                        </div>

                        <div class="col">
                            <label class="form-label">Demandado</label>
                            <input type="text" class="form-control filter-input" data-column="7">
                        </div>
                        <div class="col d-none">
                            <label class="form-label">Sede</label>
                            <input type="text" class="form-control filter-input" data-column="8">
                        </div>
                        <div class="col">
                            <label class="form-label">Situaci√≥n</label>
                            <select class="form-select filter-input" data-column="3" id="alertaSelect">
                                <option value="">Seleccionar todo</option>
                                <option value="no-observac">En Tr√°mite</option>
                                <option value="observac">En Observaci√≥n</option>
                            </select>
                        </div>
                        <div class="col">
                            <label class="form-label">Responsable</label>
                            <select class="form-select filter-input" data-column="10" id="responsableSelect">
                                <option value="">Seleccionar todo</option>
                                {% for user in usuarios_legales %}
                                    <option value="{{ user.first_name }}">
                                        {{ user.first_name }} {{ user.last_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col">
                            <label class="form-label">Alerta</label>
                            <select class="form-select filter-input" data-column="alerta" id="alertaSelect">
                                <option value="">Seleccionar todo</option>
                                <option value="danger">üü• Urgente (‚â§ 5 d√≠as)</option>
                                <option value="warning">üü® Pr√≥ximo (‚â§ 15 d√≠as)</option>
                                <option value="success">üü© A tiempo (> 15 d√≠as)</option>
                                <option value="secondary">‚¨õ Sin fecha asignada</option>
                            </select>

                        </div>
                       <div class="col">
                            <label class="form-label">Especialidad</label>
                            <select class="form-select filter-input" data-column="9" id="especialidadSelect">
                                <option value="">Seleccionar todo</option>
                                {% for esp in especialidades %}
                                    <option value="{{ esp }}">{{ esp }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Bot√≥n Limpiar Filtros -->
                        <div class="col">
                            <label class="form-label" style="color: #F2FDFF;">Limpiar</label>
                            <a href="{% url 'control_expediente:lista_expediente' %}" id="clearFilters"
                                class="form-control btn btn-secondary text-center"
                                style="background-color: #0995AD; border: none; line-height: 25px;"><i class="bi bi-eraser-fill"></i>&nbsp;Limpiar
                                Filtros</a>
                        </div>
                    </div>

                    <div id="totalExpedientes" class="mt-2 fw-bold text-dark">
                        Total de expedientes: <span id="expedienteCount">{{ caso_judiciales|length }}</span>
                    </div>

                    <!-- Bot√≥n para abrir el modal de agregar -->
                    {% if request.user.role != 1 %}
                    <center>
                        <button type="button" class="btn text-white"
                            style="background-color: #0995AD; border: none;"
                            data-bs-toggle="modal" data-bs-target="#documentModal">
                            <i class="bi bi-plus-circle"></i>&nbsp; Agregar Nuevo Expediente
                        </button>
                    </center>
                    {% endif %}
</div>

<div class="container mt-2" style="max-width: 100%;">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Tabla -->
                    <div style="max-height: 65vh; overflow-y: auto; overflow-x: auto;">
                        <table class="table table-hover table-bordered-gray" id="documentsTable">
                            <thead class="" style="position: sticky; top: 0; z-index: 1;">
                                <tr style="background-color: #26292E;">
                                    <th style="color: white; white-space: nowrap; width: 1%; text-align: center;">ITEM</th>
                                    <th style="color: white;">EXPEDIENTE</th>
                                    <th style="color: white;">√öTIMA REVISI√ìN</th>
                                    <th style="color: white;">PENDIENTE</th>
                                    <th style="color: white;">MATERIA</th>
                                    <th style="color: white;">JUZGADO</th>
                                    <th style="color: white;">DEMANDANTE</th>
                                    <th style="color: white;">DEMANDADO</th>
                                    <th style="color: white;">SEDE</th>
                                    <th style="color: white;">ESPECIALIDAD</th>
                                    <th style="color: white;">RESPONSABLE</th>
                                    <th style="color: white;" class="d-none">REPRESENTA A</th>
                                    {% if request.user.role != 1 %}
                                    <th style="color: white;">ACCIONES</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
    {% for cj in caso_judiciales %}
    <tr class="clickable-row"
        data-href="{% url 'control_expediente:ver_seguimiento' cj.id %}"
        data-alerta="{{ cj.alerta_color }}"
        >
        
        <td>{{ cj.codigo|default:'' }}</td>
        <td class="">{{ cj.expediente }}</td>
        <td class="text-nowrap">{{ cj.fecha_compromiso|default:''|date:'d/m/Y' }}</td>
        <td >{{ cj.pendiente|default:''|safe }}</td>
        <td>{{ cj.materia|default:''}}</td>
        <td>{{ cj.juzgado|default:'' }}</td>

        <td {% if cj.representante|default:'' == 'Demandante' %}
                    style="background-color: #E2FBFF; font-weight: bold;"
            {% endif %}>
            {{ cj.demandante }}
        </td>

        <td {% if cj.representante|default:'' == 'Demandado' %}
                    style="background-color: #E2FBFF; font-weight: bold;"
            {% endif %}>
            {{ cj.demandado }}
        </td>

        <td>{{ cj.sede|default:"" }}</td>
        <td>{{ cj.especialidad|default:"" }}</td>
        <td>{{ cj.responsable.first_name|default:"" }}</td>

        <td class="d-none">
            {% if cj.representante == 'demandante' %}
            Demandante
            {% elif cj.representante == 'demandado' %}
            Demandado
            {% endif %}
        </td >

        {% if request.user.role != 1 %}
        <td class="action-column text-center align-middle">
            <div class="d-flex justify-content-center align-items-center gap-2 flex-nowrap">
                <button type="button" 
                    class="btn btn-sm text-white btn-editar"
                    style="background-color: #000; border-radius: 4px;"
                    title="Editar expedeinte"
                    data-bs-toggle="modal"
                    data-bs-target="#editCasoJudicialModal"
                    
                    data-id="{{ cj.id }}"
                    data-codigo="{{ cj.codigo|default_if_none:'' }}"
                    data-expediente="{{ cj.expediente|default_if_none:'' }}"
                    data-pendiente="{{ cj.pendiente }}"
                    data-fechaseguimiento="{{ cj.fecha_compromiso|date:'Y-m-d'|default_if_none:'' }}"
                    data-sede="{{ cj.sede|default_if_none:'' }}"
                    data-especialidad="{{ cj.especialidad|default_if_none:'' }}"
                    data-materia="{{ cj.materia|default_if_none:'' }}"
                    data-juzgado="{{ cj.juzgado|default_if_none:'' }}"
                    data-demandante="{{ cj.demandante|default_if_none:'' }}"
                    data-demandado="{{ cj.demandado|default_if_none:'' }}"
                    data-anioinicio="{{ cj.anio_inicio|default_if_none:'' }}"
                    data-representante="{{ cj.representante }}"
                    data-responsable="{{ cj.responsable.id|default_if_none:'' }}"
                    data-concluido="{{ cj.concluido|default_if_none:'' }}"
                    data-seguimiento-id="{% with cj.seguimientos_ordenados.0 as ult %}{{ ult.id }}{% endwith %}">
                    <i class="bi bi-pencil-square fs-5"></i>
                </button>

                {% if request.user.role == 3 %}
                <a href="{% url 'control_expediente:eliminar_expediente' cj.id %}"
                    class="btn btn-sm text-white btnEliminar shadow-sm"
                    style="background-color: #0995AD; border-radius: 4px;"
                    title="Eliminar">
                    <i class="bi bi-trash fs-5"></i>
                </a>
                {% endif %}
                <!-- Alerta -->
                <!-- Bot√≥n de alerta -->
<a href="#"
    class="btn btn-sm text-white shadow-sm btn-alerta"
    style="background-color: var(--bs-{{ cj.alerta_color }}); border-radius: 4px;"
    title="Ver alerta"
    data-bs-toggle="modal"
    data-bs-target="#alertaModal"
    data-fecha-alerta="{% if cj.proxima_alerta %}{{ cj.proxima_alerta|date:'d/m/Y' }}{% else %}Sin alerta{% endif %}"
    data-pendiente="{{ cj.pendiente|safe|striptags|truncatechars:300 }}">
    <i class="bi bi-bell-fill fs-5"></i>
</a>

            </div>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
</tbody>
                        </table>
                    </div>

<!-- Modal de Alerta -->
<div class="modal fade" id="alertaModal" tabindex="-1" aria-labelledby="alertaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="alertaModalLabel">DETALLES DE LA ALERTA</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">FECHA:</label>
          <p id="fechaAlertaText" class="mb-0"></p>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">PENDIENTE:</label>
          <p id="pendienteText" class="mb-0"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal para agregar nueva expediente -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg" id="draggableDocumentModal">
                            <div class="modal-content">
                                <div class="modal-header text-white"
                                    id="documentModalHeader"
                                    style="background-color: #0995AD">
                                    <h5 class="modal-title" id="documentModalLabel">Agregar Nuevo Expediente</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
  <form id="expedienteForm" method="POST" action="{% url 'control_expediente:lista_expediente' %}" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.media }}
    <div class="container">
      <div class="col-md-12">
  <div class="row g-3">
    <!-- Columna 1 -->
    <div class="col-md-4">
      <label for="id_codigo" class="form-label">Item</label>
      {{ form.codigo }}
    </div>
    <div class="col-md-4">
      <label for="id_fecha" class="form-label">√öltima actualizaci√≥n</label>
      {{ form.fecha_compromiso }}
    </div>
    <div class="col-md-4">
      <label for="id_expediente" class="form-label">Expediente</label>
      {{ form.expediente }}
    </div>
    <div class="col-md-4">
      <label for="id_sede" class="form-label">Sede</label>
      {{ form.sede }}
    </div>

    <!-- Columna 2 -->
    <div class="col-md-4">
      <label for="id_especialidad" class="form-label">Especialidad</label>
      {{ form.especialidad }}
    </div>
    <div class="col-md-4">
      <label for="id_materia" class="form-label">Materia</label>
      {{ form.materia }}
    </div>
    <div class="col-md-4">
      <label for="id_juzgado" class="form-label">Juzgado</label>
      {{ form.juzgado }}
    </div>

    <!-- Columna 3 -->
    <div class="col-md-4">
      <label for="id_demandante" class="form-label">Demandante</label>
      {{ form.demandante }}
    </div>
    <div class="col-md-4">
      <label for="id_demandado" class="form-label">Demandado</label>
      {{ form.demandado }}
    </div>
    <div class="col-md-4">
      <label for="id_representante" class="form-label">Responsable</label>
      {{ form.responsable }}
    </div>
    <div class="col-md-8">
      <label for="id_representante" class="form-label">Representa a</label>
      {{ form.representante }}
    </div>
  </div>
</div>


      <div class="text-center mt-4">
        <button type="submit" class="btn px-5 py-2 btnGuardar" style="background-color: #000; color: white;">Guardar</button>
      </div>
    </div>
  </form>
</div>

                            </div>
                        </div>
                    </div>

<!-- Modal para editar expediente -->
<div class="modal fade" id="editCasoJudicialModal" tabindex="-1"
    aria-labelledby="editCasoJudicialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" id="editCasoJudicialDialog">
        <div class="modal-content">
            <div class="modal-header text-white" id="editCasoJudicialHeader"
                style="background-color: #0995AD;">
                <h5 class="modal-title" id="editCasoJudicialModalLabel">Editar Expediente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'control_expediente:editar_expediente' %}">
                    {% csrf_token %}
                    <input type="hidden" id="edit_id" name="id">
                    <input type="hidden" id="edit_seguimiento_id" name="seguimiento_id">
                    
                    <div class="container">
                        <div class="row g-3">
                            <!-- Primera Fila -->
                            <div class="col-md-4">
                                <label for="edit_id_codigo" class="form-label">Item</label>
                                <input type="text" class="form-control" id="edit_id_codigo" name="codigo">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_expediente" class="form-label">Expediente</label>
                                <input type="text" class="form-control" id="edit_id_expediente" name="expediente">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_fecha" class="form-label">√öltima actualizaci√≥n</label>
                                <input type="date" class="form-control" id="edit_id_fecha_compromiso" name="fecha_compromiso">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_sede" class="form-label">Sede</label>
                                <input type="text" class="form-control" id="edit_id_sede" name="sede">
                            </div>

                            <!-- Segunda Fila -->
                            <div class="col-md-4">
                                <label for="edit_id_especialidad" class="form-label">Especialidad</label>
                                <input type="text" class="form-control" id="edit_id_especialidad" name="especialidad">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_materia" class="form-label">Materia</label>
                                <input type="text" class="form-control" id="edit_id_materia" name="materia">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_juzgado" class="form-label">Juzgado</label>
                                <input type="text" class="form-control" id="edit_id_juzgado" name="juzgado">
                            </div>

                            <!-- Tercera Fila -->
                            <div class="col-md-4">
                                <label for="edit_id_demandante" class="form-label">Demandante</label>
                                <input type="text" class="form-control" id="edit_id_demandante" name="demandante">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_demandado" class="form-label">Demandado</label>
                                <input type="text" class="form-control" id="edit_id_demandado" name="demandado">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_representante" class="form-label">Responsable</label>
                                <select class="form-control" id="edit_responsable" name="responsable">
                                    {% for user in usuarios_legales %}
                                        <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_representante" class="form-label">Representa a</label>
                                <select class="form-control" id="edit_id_representante" name="representante">
                                    <option value="Demandante">Demandante</option>
                                    <option value="Demandado">Demandado</option>
                                    <option value="Martillero">Martillero</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="edit_id_concluido" class="form-label" style="color: #0995AD">Estado</label>
                                <select class="form-control" id="edit_concluido" name="concluido">
                                    <option value="True">Activo</option>
                                    <option value="False">Concluido</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-none">
                                <label class="form-label">Pendiente</label>
                                <textarea class="form-control ckeditor" id="edit_id_pendiente" name="pendiente"></textarea>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn px-5 py-2 btnGuardar2"
                                style="background-color: #000; color: #fff;">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

window.addEventListener("pageshow", function (event) {
    if (event.persisted) {
        window.location.reload();
    }
});


                        CKEDITOR.replace('edit_id_pendiente', {
                            toolbar: [
                                { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike'] },
                                { name: 'colors', items: ['TextColor', 'BGColor'] },
                                { name: 'paragraph', items: ['NumberedList', 'BulletedList'] }
                            ]
                        });


                        function makeModalDraggable(modalId, dialogId, headerId) {
    const modal = document.getElementById(modalId);
    const modalDialog = document.getElementById(dialogId);
    const modalHeader = document.getElementById(headerId);

    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    modal.addEventListener('shown.bs.modal', function () {
        const rect = modalDialog.getBoundingClientRect();
        modalDialog.style.position = 'fixed';
        modalDialog.style.top = rect.top + 'px';
        modalDialog.style.left = rect.left + 'px';
        modalDialog.style.margin = '0';
        modalDialog.style.transform = 'none';
        modalDialog.style.width = rect.width + 'px';
    });

    modalHeader.addEventListener('mousedown', function (e) {
        if (e.target.closest('button')) return;
        isDragging = true;
        const rect = modalDialog.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
    });

    document.addEventListener('mousemove', function (e) {
        if (isDragging) {
            modalDialog.style.top = `${e.clientY - offsetY}px`;
            modalDialog.style.left = `${e.clientX - offsetX}px`;
        }
    });

    document.addEventListener('mouseup', function () {
        isDragging = false;
    });

    modal.addEventListener('hidden.bs.modal', function () {
        modalDialog.removeAttribute('style');
    });
}

                        document.addEventListener("DOMContentLoaded", function () {

                            // MODALES MOVIBLES
                            makeModalDraggable('documentModal', 'draggableDocumentModal', 'documentModalHeader');
                            makeModalDraggable('editCasoJudicialModal', 'editCasoJudicialDialog', 'editCasoJudicialHeader');


                            const table = document.getElementById("documentsTable");
                            const tbody = table.querySelector("tbody");
                            const rows = Array.from(tbody.querySelectorAll("tr"));

                            // Funci√≥n para extraer a√±o y n√∫mero de c√≥digo tipo "008-23"
                            function parseCodigo(codigo) {
                                const [numStr, yearStr] = codigo.split("-");
                                const numero = parseInt(numStr, 10);
                                const anio = parseInt(yearStr, 10);
                                return { anio, numero };
                            }

                            rows.sort((a, b) => {
                                const codigoA = a.children[0].textContent.trim();
                                const codigoB = b.children[0].textContent.trim();

                                const aParsed = parseCodigo(codigoA);
                                const bParsed = parseCodigo(codigoB);

                                // Primero ordenar por a√±o, luego por n√∫mero
                                if (aParsed.anio !== bParsed.anio) {
                                    return aParsed.anio - bParsed.anio;
                                } else {
                                    return aParsed.numero - bParsed.numero;
                                }
                            });

                            // Vac√≠a el tbody y vuelve a agregar las filas ordenadas
                            tbody.innerHTML = "";
                            rows.forEach(row => tbody.appendChild(row));
                        });

                        document.addEventListener('DOMContentLoaded', function () {

                            const rows = document.querySelectorAll(".clickable-row");

        rows.forEach(row => {
            row.addEventListener("click", function (e) {
                // Evita que haga redirect si se hace clic en un bot√≥n o enlace dentro de la fila
                if (e.target.closest(".action-column") || e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('.btn-group')) {
                    return;
                }
                const url = this.dataset.href;
                if (url) {
                    window.location.href = url;
                }
            });
        });


    // FILTRO EN TIEMPO REAL
document.querySelectorAll('.filter-input').forEach(input => {
    input.addEventListener('input', filtrarTabla);
});

function filtrarTabla() {
    const filtros = {};

    // Recoger los valores de todos los filtros activos
    document.querySelectorAll('.filter-input').forEach(input => {
        const columna = input.dataset.column;
        const valor = input.value.trim().toLowerCase();
        if (valor) {
            filtros[columna] = valor;
        }
    });

    // Recorrer las filas del cuerpo de la tabla
    document.querySelectorAll('#documentsTable tbody tr').forEach(fila => {
        let mostrar = true;

        // Filtrado por columnas
        for (const columna in filtros) {
            if (columna === "alerta") continue; // se maneja aparte
            const celda = fila.cells[parseInt(columna)];
            if (!celda) continue;

            const textoCelda = celda.textContent.trim().toLowerCase();
            const filtroValor = filtros[columna];

            // üîπ Filtro especial: columna "Situaci√≥n" (ej. columna 3)
            if (parseInt(columna) === 3) {
                if (filtroValor === "observac") {
                    // Mostrar solo los que contienen "observac"
                    if (!textoCelda.includes("observac")) {
                        mostrar = false;
                        break;
                    }
                } else if (filtroValor === "no-observac") {
                    // Mostrar los que NO contienen "observac"
                    if (textoCelda.includes("observac")) {
                        mostrar = false;
                        break;
                    }
                } else {
                    // Comportamiento normal por si acaso
                    if (!textoCelda.includes(filtroValor)) {
                        mostrar = false;
                        break;
                    }
                }
            } else {
                // üî∏ Filtro normal para otras columnas
                if (!textoCelda.includes(filtroValor)) {
                    mostrar = false;
                    break;
                }
            }
        }

        // üî∏ Filtro especial por color de alerta (si aplica)
        if (mostrar && filtros["alerta"]) {
            const colorFila = fila.dataset.alerta ? fila.dataset.alerta.toLowerCase() : "";
            if (colorFila !== filtros["alerta"]) {
                mostrar = false;
            }
        }

        // Mostrar u ocultar la fila seg√∫n corresponda
        fila.style.display = mostrar ? '' : 'none';
    });

    // üîπ Disparar evento para actualizar el contador de expedientes
    document.dispatchEvent(new Event("filtradoRealizado"));
}


    // EDITAR REGISTRO
    const editButtons = document.querySelectorAll('.btn-editar');
    editButtons.forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault(); // Si el bot√≥n es un enlace, previene la redirecci√≥n autom√°tica

            const codigo = button.getAttribute('data-codigo');
            const partida = button.getAttribute('data-partida');
            const id = button.getAttribute('data-id');

            document.getElementById('edit_id').value = id;
            document.getElementById('edit_id_codigo').value = codigo;
            document.getElementById('edit_id_expediente').value = button.getAttribute('data-expediente');
            document.getElementById('edit_id_sede').value = button.getAttribute('data-sede');
            document.getElementById('edit_id_especialidad').value = button.getAttribute('data-especialidad');
            document.getElementById('edit_id_materia').value = button.getAttribute('data-materia');
            document.getElementById('edit_id_juzgado').value = button.getAttribute('data-juzgado');
            document.getElementById('edit_id_demandante').value = button.getAttribute('data-demandante');
            document.getElementById('edit_id_demandado').value = button.getAttribute('data-demandado');
            document.getElementById('edit_id_fecha_compromiso').value = button.getAttribute('data-fechaseguimiento');

            console.log( button.getAttribute('data-fechaseguimiento'));
            

            document.getElementById('edit_id_representante').value = button.getAttribute('data-representante');
            document.getElementById('edit_responsable').value = button.getAttribute('data-responsable');
            document.getElementById('edit_concluido').value = button.getAttribute('data-concluido');
            console.log(button.getAttribute('data-responsable'));
            
            document.getElementById('edit_seguimiento_id').value = button.getAttribute('data-seguimiento-id') || '';
            
            const observacionHtml2 = button.getAttribute('data-pendiente');
            if (CKEDITOR.instances['edit_id_pendiente']) {
                    CKEDITOR.instances['edit_id_pendiente'].setData(observacionHtml2 || '');
                }
        });
    });

});


                        // BTN GUARDAR
                        (function () {
                            const botonesGuardar = document.querySelectorAll('.btnGuardar');

                            botonesGuardar.forEach(boton => {
                                boton.addEventListener('click', function (e) {
                                    e.preventDefault(); // Detiene env√≠o por defecto

                                    const form = this.closest('form');
                                    const campos = form.querySelectorAll("input, select, textarea");
                                    let formValido = true;

                                    campos.forEach(campo => {
                                        if (
                                            campo.offsetParent !== null && // Solo visibles
                                            campo.hasAttribute("required") && 
                                            !campo.value.trim()
                                        ) {
                                            formValido = false;
                                        }
                                    });

                                    if (!formValido) {
                                        Swal.fire({
                                            icon: 'warning',
                                            title: 'Campos incompletos',
                                            text: 'Por favor completa todos los campos obligatorios.',
                                            confirmButtonText: 'Entendido',
                                            confirmButtonColor: '#BF0909',
                                        });
                                        return; // Evita que siga
                                    }

                                    // Si est√° todo completo
                                    const Toast = Swal.mixin({
                                        toast: true,
                                        position: "top-end",
                                        showConfirmButton: false,
                                        timer: 1000,
                                        timerProgressBar: true,
                                        didOpen: (toast) => {
                                            toast.onmouseenter = Swal.stopTimer;
                                            toast.onmouseleave = Swal.resumeTimer;
                                        }
                                    });

                                    Toast.fire({
                                        icon: "success",
                                        title: "Registro guardado correctamente"
                                    }).then(() => {
                                        form.submit(); // Reci√©n aqu√≠ se env√≠a
                                    });
                                });
                            });
                        })();

                        // BTN ACTUALIZAR
                        (function () {
                            const botonesGuardar = document.querySelectorAll('.btnGuardar2');

                            botonesGuardar.forEach(boton => {
                                boton.addEventListener('click', function (e) {
                                    e.preventDefault(); // Previene el submit inmediato

                                    const form = this.closest('form');

                                    const Toast = Swal.mixin({
                                        toast: true,
                                        position: "top-end",
                                        showConfirmButton: false,
                                        timer: 1000,
                                        timerProgressBar: true,
                                        didOpen: (toast) => {
                                            toast.onmouseenter = Swal.stopTimer;
                                            toast.onmouseleave = Swal.resumeTimer;
                                        }
                                    });

                                    Toast.fire({
                                        icon: "success",
                                        title: "Registro actualizado correctamente"
                                    }).then(() => {
                                        form.submit(); // Enviar el formulario despu√©s del toast
                                    });
                                });
                            });
                        })();

                        // BTN ELIMINAR
                        (function () {
        const botonesEliminar = document.querySelectorAll('.btnEliminar');

        botonesEliminar.forEach(boton => {
            boton.addEventListener('click', function (e) {
                e.preventDefault(); // Evita que el enlace se siga inmediatamente

                Swal.fire({
                    title: '¬øEst√°s seguro de eliminar?',
                    text: "Esta acci√≥n no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#BF0909',
                    cancelButtonColor: '#6F6F6F',
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redirige al href del bot√≥n
                        window.location.href = this.href;
                    }
                });
            });
        });
    })();

    document.addEventListener("DOMContentLoaded", function() {
    const table = document.getElementById("documentsTable");
    const countSpan = document.getElementById("expedienteCount");

    function getBaseItem(value) {
        const text = value.trim().toLowerCase();
        const match = text.match(/^(\d+)/);
        return match ? match[1] : null; // devuelve n√∫mero base si hay, null si no
    }

    function updateCount() {
        const visibleRows = Array.from(table.querySelectorAll("tbody tr"))
            .filter(row => row.style.display !== "none");

        const uniqueNumericItems = new Set();
        let total = 0;

        visibleRows.forEach(row => {
            const itemCell = row.cells[0]; // Columna 0 es el "Item"
            if (itemCell) {
                const text = itemCell.textContent.trim();
                const base = getBaseItem(text);
                if (base) {
                    // Si tiene n√∫mero, solo contamos una vez por base
                    if (!uniqueNumericItems.has(base)) {
                        uniqueNumericItems.add(base);
                        total++;
                    }
                } else {
                    // Si no tiene n√∫mero (ej. "martillero"), contar normalmente
                    total++;
                }
            }
        });

        countSpan.textContent = total;
    }

    // Mostrar al cargar
    updateCount();

    // Actualizar contador al escribir en filtros
    document.querySelectorAll(".filter-input").forEach(input => {
        input.addEventListener("input", updateCount);
    });

    // Permite que filtrarTabla dispare el conteo
    document.addEventListener("filtradoRealizado", updateCount);
});

document.addEventListener("DOMContentLoaded", () => {
    const alertaModal = document.getElementById('alertaModal');
    const fechaAlertaText = document.getElementById('fechaAlertaText');
    const pendienteText = document.getElementById('pendienteText');

    // Cuando el modal est√° a punto de mostrarse
    alertaModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; // el bot√≥n que dispar√≥ el modal
        const fecha = button.getAttribute('data-fecha-alerta') || "Sin fecha asignada";
        const pendiente = button.getAttribute('data-pendiente') || "Sin pendiente asignado.";

        fechaAlertaText.textContent = fecha;
        pendienteText.textContent = pendiente;
    });
});
</script>

{% endblock %}